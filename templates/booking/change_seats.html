{% extends 'base.html' %}
{% block title %}{{ 'Change Seats' if current_language=='en' else 'Changer de Places' }} — {{ site_name }}{% endblock %}

{% block extra_css %}
<style>
  .booking-summary {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    border: 1px solid #e2e8f0;
  }
  
  .current-booking {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }
  
  .booking-detail {
    text-align: center;
  }
  
  .detail-label {
    font-size: 0.75rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  
  .detail-value {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.95rem;
  }
  
  .route-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 16px;
  }
  
  .route-arrow {
    color: #3b82f6;
    font-size: 1.2rem;
  }
  
  .current-seats {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .current-seat {
    background: #dc2626;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  
  .seat-selection-area {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  }
  
  .bus-layout {
    max-width: 400px;
    margin: 0 auto;
    background: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    border: 2px solid #e2e8f0;
  }
  
  .driver-area {
    text-align: right;
    margin-bottom: 16px;
    padding: 8px 12px;
    background: #1e293b;
    color: white;
    border-radius: 6px;
    font-size: 0.8rem;
  }
  
  .seat-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    gap: 8px;
  }
  
  .seat {
    width: 40px;
    height: 40px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    background: #fff;
  }
  
  .seat.available {
    border-color: #10b981;
    color: #10b981;
  }
  
  .seat.available:hover {
    background: #10b981;
    color: white;
    transform: scale(1.05);
  }
  
  .seat.selected {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
    transform: scale(1.05);
  }
  
  .seat.booked {
    background: #ef4444;
    color: white;
    border-color: #ef4444;
    cursor: not-allowed;
  }
  
  .seat.current {
    background: #f59e0b;
    color: white;
    border-color: #f59e0b;
    cursor: not-allowed;
  }
  
  .seat-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
  }
  
  .legend-seat {
    width: 16px;
    height: 16px;
    border-radius: 3px;
  }
  
  .change-summary {
    background: #f0f9ff;
    border: 1px solid #0ea5e9;
    border-radius: 8px;
    padding: 16px;
    margin: 20px 0;
  }
  
  .change-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 24px;
    flex-wrap: wrap;
  }
  
  .action-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 140px;
    justify-content: center;
  }
  
  .btn-confirm {
    background: #10b981;
    color: white;
  }
  
  .btn-confirm:hover {
    background: #059669;
    color: white;
    transform: translateY(-1px);
  }
  
  .btn-cancel {
    background: #6b7280;
    color: white;
  }
  
  .btn-cancel:hover {
    background: #4b5563;
    color: white;
    transform: translateY(-1px);
  }
  
  .btn-confirm:disabled {
    background: #d1d5db;
    color: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }
  
  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .alert-warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #f59e0b;
  }
  
  .alert-info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #3b82f6;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">{{ 'Change Seats' if current_language=='en' else 'Changer de Places' }}</h2>
      <p class="text-muted mb-0">{{ 'Select new seats for your booking' if current_language=='en' else 'Sélectionnez de nouvelles places pour votre réservation' }}</p>
    </div>
    <a href="/{{ current_language }}/my-bookings" class="btn btn-outline-secondary">
      <i class="fa-solid fa-arrow-left me-2"></i>
      {{ 'Back to Bookings' if current_language=='en' else 'Retour aux Réservations' }}
    </a>
  </div>

  <!-- Current Booking Summary -->
  <div class="booking-summary">
    <h5 class="mb-3">
      <i class="fa-solid fa-ticket me-2"></i>
      {{ 'Current Booking' if current_language=='en' else 'Réservation Actuelle' }}
    </h5>
    
    <div class="route-display">
      <span>{{ booking.trip.route.origin }}</span>
      <i class="fa-solid fa-arrow-right route-arrow"></i>
      <span>{{ booking.trip.route.destination }}</span>
    </div>
    
    <div class="current-booking">
      <div class="booking-detail">
        <div class="detail-label">{{ 'Reference' if current_language=='en' else 'Référence' }}</div>
        <div class="detail-value">{{ booking.booking_reference }}</div>
      </div>
      
      <div class="booking-detail">
        <div class="detail-label">{{ 'Date & Time' if current_language=='en' else 'Date & Heure' }}</div>
        <div class="detail-value">{{ booking.trip.departure_time.strftime('%d/%m/%Y %H:%M') }}</div>
      </div>
      
      <div class="booking-detail">
        <div class="detail-label">{{ 'Operator' if current_language=='en' else 'Agence' }}</div>
        <div class="detail-value">{{ booking.trip.operator.name }}</div>
      </div>
      
      <div class="booking-detail">
        <div class="detail-label">{{ 'Current Seats' if current_language=='en' else 'Places Actuelles' }}</div>
        <div class="current-seats">
          {% for seat in current_seats %}
            <span class="current-seat">{{ seat }}</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Messages -->
  <div class="alert alert-warning">
    <i class="fa-solid fa-exclamation-triangle"></i>
    <div>
      <strong>{{ 'Important:' if current_language=='en' else 'Important :' }}</strong>
      {{ 'Seat changes are free but must be done at least 2 hours before departure.' if current_language=='en' else 'Les changements de places sont gratuits mais doivent être effectués au moins 2 heures avant le départ.' }}
    </div>
  </div>

  <!-- Seat Selection -->
  <div class="seat-selection-area">
    <h5 class="mb-3 text-center">
      <i class="fa-solid fa-chair me-2"></i>
      {{ 'Select New Seats' if current_language=='en' else 'Sélectionnez de Nouvelles Places' }}
    </h5>

    <!-- Seat Legend -->
    <div class="seat-legend">
      <div class="legend-item">
        <div class="legend-seat" style="background: #10b981;"></div>
        <span>{{ 'Available' if current_language=='en' else 'Disponible' }}</span>
      </div>
      <div class="legend-item">
        <div class="legend-seat" style="background: #3b82f6;"></div>
        <span>{{ 'Selected' if current_language=='en' else 'Sélectionné' }}</span>
      </div>
      <div class="legend-item">
        <div class="legend-seat" style="background: #f59e0b;"></div>
        <span>{{ 'Your Current' if current_language=='en' else 'Votre Actuel' }}</span>
      </div>
      <div class="legend-item">
        <div class="legend-seat" style="background: #ef4444;"></div>
        <span>{{ 'Occupied' if current_language=='en' else 'Occupé' }}</span>
      </div>
    </div>

    <!-- Bus Layout -->
    <div class="bus-layout">
      <div class="driver-area">
        <i class="fa-solid fa-steering-wheel me-2"></i>
        {{ 'Driver' if current_language=='en' else 'Chauffeur' }}
      </div>
      
      <div id="seatLayout">
        {% for row in seat_layout %}
        <div class="seat-row">
          {% for seat in row %}
            <div class="seat {{ 'current' if seat.number in current_seats else ('booked' if seat.number in booked_seats else 'available') }}" 
                 data-seat="{{ seat.number }}">
              {{ seat.number }}
            </div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Change Summary -->
    <div class="change-summary" id="changeSummary" style="display: none;">
      <h6 class="mb-2">
        <i class="fa-solid fa-exchange-alt me-2"></i>
        {{ 'Seat Change Summary' if current_language=='en' else 'Résumé du Changement de Places' }}
      </h6>
      <div id="summaryContent"></div>
    </div>

    <!-- Action Buttons -->
    <div class="change-actions">
      <button id="confirmBtn" class="action-btn btn-confirm" onclick="confirmSeatChange()" disabled>
        <i class="fa-solid fa-check"></i>
        {{ 'Confirm Change' if current_language=='en' else 'Confirmer le Changement' }}
      </button>
      
      <a href="/{{ current_language }}/my-bookings" class="action-btn btn-cancel">
        <i class="fa-solid fa-times"></i>
        {{ 'Cancel' if current_language=='en' else 'Annuler' }}
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Template Variables -->
<script id="template-data" type="application/json">
{
  "lang": "{{ current_language }}",
  "bookingId": {{ booking.id }},
  "currentSeats": {{ current_seats|tojson|safe }}
}
</script>

<script>
  // Get template data
  const templateData = JSON.parse(document.getElementById('template-data').textContent);
  const lang = templateData.lang;
  const bookingId = templateData.bookingId;
  const currentSeats = templateData.currentSeats;
  let selectedSeats = new Set();

  // Event delegation for seat selection
  document.addEventListener('DOMContentLoaded', function() {
    const seatLayout = document.getElementById('seatLayout');
    
    seatLayout.addEventListener('click', function(event) {
      const seatElement = event.target.closest('.seat');
      if (!seatElement) return;
      
      const seatNumber = parseInt(seatElement.dataset.seat);
      toggleSeat(seatNumber, seatElement);
    });
    
    updateSummary();
  });

  function toggleSeat(seatNumber, element) {
    // Don't allow selection of current seats or booked seats
    if (element.classList.contains('current') || element.classList.contains('booked')) {
      return;
    }

    if (selectedSeats.has(seatNumber)) {
      selectedSeats.delete(seatNumber);
      element.classList.remove('selected');
      element.classList.add('available');
    } else {
      // Only allow selecting the same number of seats as currently booked
      if (selectedSeats.size >= currentSeats.length) {
        alert(lang === 'en' 
          ? `You can only select ${currentSeats.length} seat(s) as per your original booking.`
          : `Vous ne pouvez sélectionner que ${currentSeats.length} place(s) selon votre réservation originale.`);
        return;
      }
      
      selectedSeats.add(seatNumber);
      element.classList.remove('available');
      element.classList.add('selected');
    }

    updateSummary();
  }

  function updateSummary() {
    const summaryDiv = document.getElementById('changeSummary');
    const summaryContent = document.getElementById('summaryContent');
    const confirmBtn = document.getElementById('confirmBtn');

    if (selectedSeats.size === 0) {
      summaryDiv.style.display = 'none';
      confirmBtn.disabled = true;
      return;
    }

    if (selectedSeats.size !== currentSeats.length) {
      summaryDiv.style.display = 'none';
      confirmBtn.disabled = true;
      return;
    }

    // Show summary
    summaryDiv.style.display = 'block';
    confirmBtn.disabled = false;

    const selectedArray = Array.from(selectedSeats).sort((a, b) => a - b);
    
    summaryContent.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <strong>${lang === 'en' ? 'From:' : 'De :'}</strong> ${currentSeats.join(', ')}
        </div>
        <div class="col-md-6">
          <strong>${lang === 'en' ? 'To:' : 'Vers :'}</strong> ${selectedArray.join(', ')}
        </div>
      </div>
      <div class="mt-2 text-center">
        <small class="text-muted">
          ${lang === 'en' ? 'No additional charges for seat changes' : 'Aucun frais supplémentaire pour les changements de places'}
        </small>
      </div>
    `;
  }

  async function confirmSeatChange() {
    if (selectedSeats.size === 0) return;

    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = `
      <i class="fa-solid fa-spinner fa-spin"></i>
      ${lang === 'en' ? 'Processing...' : 'Traitement...'}
    `;

    try {
      const response = await fetch(`/${lang}/api/change-seats`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          booking_id: bookingId,
          new_seats: Array.from(selectedSeats)
        })
      });

      const result = await response.json();

      if (result.success) {
        alert(lang === 'en' 
          ? 'Seats changed successfully! Redirecting to your bookings...'
          : 'Places changées avec succès ! Redirection vers vos réservations...');
        
        window.location.href = `/${lang}/my-bookings`;
      } else {
        throw new Error(result.message || 'Unknown error');
      }
    } catch (error) {
      alert(lang === 'en' 
        ? `Error changing seats: ${error.message}`
        : `Erreur lors du changement de places : ${error.message}`);
      
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = `
        <i class="fa-solid fa-check"></i>
        ${lang === 'en' ? 'Confirm Change' : 'Confirmer le Changement'}
      `;
    }
  }
</script>
{% endblock %}
