{% extends 'base.html' %}
{% block title %}{{ 'Select Seats' if current_language=='en' else 'Choisir les places' }} — {{ site_name }}{% endblock %}

{% block extra_css %}
<style>
  .seat { width: 40px; height: 40px; border-radius: 8px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; font-weight:600; font-size:0.85rem; transition: transform .15s ease; }
  .seat.standard { background:#28a745; color:#fff; border:2px solid #1e7e34; }
  .seat.premium { background:#ffc107; color:#212529; border:2px solid #d39e00; }
  .seat.disabled { background:#6c757d; color:#fff; border:2px solid #495057; cursor:not-allowed; }
  .seat.aisle { background:transparent; border:2px dashed #dee2e6; color:#6c757d; cursor:default; }
  .seat.booked { background:#e5e7eb !important; color:#6b7280 !important; border:2px solid #cbd5e1 !important; cursor:not-allowed; }
  .seat.selected { background:#0d6efd !important; color:#fff !important; border-color:#0d6efd !important; box-shadow: 0 0 0 3px rgba(13,110,253,.35); transform: scale(1.03); }
  .seat-grid { display:flex; flex-direction:column; gap:10px; }
  .legend .badge { min-width: 110px; }
  .aisle-space { width: 20px; height: 40px; display:flex; align-items:center; justify-content:center; }
  .aisle-space::after { content:''; width:3px; height:30px; background: linear-gradient(135deg, #dee2e6 0%, #adb5bd 100%); border-radius:2px; }
  @media (max-width: 768px) { .seat{ width:34px; height:34px; font-size:.75rem; } .aisle-space{ height:34px; } }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h3 class="mb-3">{{ trip.route.origin }} → {{ trip.route.destination }}</h3>
  <div class="text-secondary mb-3">
    {{ 'Departure' if current_language=='en' else 'Départ' }}: {{ trip.departure_time.strftime('%d/%m/%Y %H:%M') }} · {{ 'Seat price' if current_language=='en' else 'Prix par place' }}: {{ '%.0f'|format(trip.seat_price) }} XAF
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card p-3">
        <div class="d-flex align-items-center gap-2 legend mb-3">
          <span class="badge bg-light text-dark">{{ 'Available' if current_language=='en' else 'Disponible' }}</span>
          <span class="badge bg-primary">{{ 'Selected' if current_language=='en' else 'Sélectionné' }}</span>
          <span class="badge bg-secondary">{{ 'Booked' if current_language=='en' else 'Réservé' }}</span>
        </div>
        <div id="seatGrid" class="seat-grid"></div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card p-3">
        <h5 class="mb-2">{{ 'Your selection' if current_language=='en' else 'Votre sélection' }}</h5>
        <div class="small text-secondary mb-2">{{ 'Click seats to select/deselect.' if current_language=='en' else 'Cliquez sur les places pour sélectionner/désélectionner.' }}</div>
        <div class="mb-2"><strong>{{ 'Seats' if current_language=='en' else 'Places' }}:</strong> <span id="selSeats">-</span></div>
        <div class="mb-3"><strong>{{ 'Total' if current_language=='en' else 'Total' }}:</strong> <span id="total">0</span> XAF</div>
        <button id="continueBtn" class="btn btn-primary w-100" disabled>
          {{ 'Continue' if current_language=='en' else 'Continuer' }}
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const lang = "{{ current_language }}";
  const tripId = Number("{{ trip.id }}");
  const seatPrice = Number("{{ trip.seat_price|int }}");
  const booked = JSON.parse('{{ booked_seats|tojson|safe }}');
  const seatLayout = JSON.parse('{{ seat_layout|tojson|safe }}');

  // Determine configuration (used for aisle heuristics)
  const seatsPerRow = Number("{{ seats_per_row }}");
  const totalSeats = Number("{{ total_seats }}");

  const seatGrid = document.getElementById('seatGrid');
  const selected = new Set();

  function buildGrid() {
    seatGrid.innerHTML = '';
    // Add front indicator
    const front = document.createElement('div');
    front.className = 'text-center text-secondary mb-2';
    front.textContent = lang==='en' ? 'FRONT' : 'AVANT';
    seatGrid.appendChild(front);

    // Column labels row (based on first row)
    if (seatLayout.length) {
      // Legend (e.g., 2+2 or 3+2 based on inferred split)
      const firstRow = seatLayout[0];
      const hasAisle = firstRow.length >= 3;
      let aislePosition;
      if (firstRow.length === 4) aislePosition = 1;
      else if (firstRow.length === 5) aislePosition = 2;
      else if (firstRow.length === 3) aislePosition = 1;
      else aislePosition = Math.floor(firstRow.length / 2) - 1;
      const leftCount = hasAisle ? (aislePosition + 1) : firstRow.length;
      const rightCount = hasAisle ? (firstRow.length - leftCount) : 0;
      const legend = document.createElement('div');
      legend.className = 'text-center text-muted small mb-1';
      legend.textContent = hasAisle ? `${leftCount}+${rightCount}` : `${firstRow.length}`;
      seatGrid.appendChild(legend);

      const labelRow = document.createElement('div');
      labelRow.className = 'd-flex justify-content-center align-items-center mb-1 gap-2';
      firstRow.forEach((seat, seatIndex) => {
        const label = document.createElement('div');
        label.style.width = '40px';
        label.className = 'text-secondary small text-center';
        label.textContent = String.fromCharCode(65 + seatIndex); // A,B,C...
        labelRow.appendChild(label);

        // Aisle marker alignment like admin
        const hasAisle = firstRow.length >= 3;
        let aislePosition;
        if (firstRow.length === 4) aislePosition = 1;
        else if (firstRow.length === 5) aislePosition = 2;
        else if (firstRow.length === 3) aislePosition = 1;
        else aislePosition = Math.floor(firstRow.length / 2) - 1;
        if (hasAisle && seatIndex === aislePosition) {
          const aisle = document.createElement('div');
          aisle.className = 'aisle-space';
          labelRow.appendChild(aisle);
        }
      });
      seatGrid.appendChild(labelRow);
    }

    seatLayout.forEach((row) => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'd-flex justify-content-center align-items-center mb-2 gap-2';

      row.forEach((seat, seatIndex) => {
        const num = seat.number;
        const type = seat.type || 'standard';
        const isBooked = booked.map(String).includes(String(num));

        const el = document.createElement('div');
        el.className = `seat ${type} ${isBooked ? 'booked' : 'available'}`;
        el.textContent = (type === 'aisle') ? '' : num;
        el.dataset.num = String(num);
        if (type !== 'aisle') {
          el.title = `${type.charAt(0).toUpperCase()+type.slice(1)} — #${num}`;
        }

        const selectable = type !== 'aisle' && type !== 'disabled' && !isBooked;
        if (selectable) {
          el.addEventListener('click', () => toggleSeat(num, el));
        } else {
          el.style.cursor = 'not-allowed';
        }

        rowDiv.appendChild(el);

        // Insert aisle space using same heuristic as admin editor
        const hasAisle = row.length >= 3;
        let aislePosition;
        if (row.length === 4) {
          aislePosition = 1; // after 2nd seat
        } else if (row.length === 5) {
          aislePosition = 2; // after 3rd seat
        } else if (row.length === 3) {
          aislePosition = 1; // after 2nd seat
        } else {
          aislePosition = Math.floor(row.length / 2) - 1;
        }
        if (hasAisle && seatIndex === aislePosition) {
          const aisle = document.createElement('div');
          aisle.className = 'aisle-space';
          rowDiv.appendChild(aisle);
        }
      });

      seatGrid.appendChild(rowDiv);
    });

    // Add back indicator
    const back = document.createElement('div');
    back.className = 'text-center text-secondary mt-1';
    back.textContent = lang==='en' ? 'BACK' : 'ARRIÈRE';
    seatGrid.appendChild(back);
  }

  function toggleSeat(num, el){
    if (selected.has(num)) { selected.delete(num); el.classList.remove('selected'); }
    else { selected.add(num); el.classList.add('selected'); }
    updateSummary();
    
    // Auto-scroll to continue button after seat selection
    if (selected.size > 0) {
      setTimeout(() => {
        const continueBtn = document.getElementById('continueBtn');
        continueBtn.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
        
        // Add a subtle highlight effect to draw attention
        continueBtn.style.transform = 'scale(1.05)';
        continueBtn.style.boxShadow = '0 0 20px rgba(13, 110, 253, 0.5)';
        
        setTimeout(() => {
          continueBtn.style.transform = '';
          continueBtn.style.boxShadow = '';
        }, 1000);
      }, 300);
    }
  }

  function updateSummary(){
    const list = Array.from(selected).sort((a,b)=>a-b);
    document.getElementById('selSeats').textContent = list.length ? list.join(', ') : '-';
    document.getElementById('total').textContent = (list.length * seatPrice).toLocaleString();
    document.getElementById('continueBtn').disabled = list.length===0;
  }

  async function continueNext(){
    const seats = Array.from(selected).sort((a,b)=>a-b);
    const res = await fetch('/api/select-seats', {
      method: 'POST', headers: { 'Content-Type':'application/json', 'Accept-Language': lang },
      body: JSON.stringify({ trip_id: tripId, seats })
    });
    const data = await res.json();
    if (data && data.redirect) { window.location.href = data.redirect; }
  }

  document.getElementById('continueBtn').addEventListener('click', continueNext);
  buildGrid();
</script>
{% endblock %}
