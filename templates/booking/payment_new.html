{% extends 'base.html' %}
{% block title %}{{ 'Payment' if current_language=='en' else 'Paiement' }} — {{ site_name }}{% endblock %}

{% block extra_css %}
<style>
  .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index: 1050; }
  .loading-card { background:#fff; padding:16px 20px; border-radius: 10px; box-shadow: 0 10px 30px rgba(16,24,40,.25); min-width: 300px; }
  .spinner { width:24px; height:24px; border:3px solid #e2e8f0; border-top-color:#0d6efd; border-radius:50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .status-line { font-size: .95rem; }
  .dim { opacity:.6 }
  .hidden { display:none; }
  .success { color: #0f5132 }
  .pending { color: #664d03 }
  .error { color: #842029 }
  .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card p-3 p-md-4">
        <h4 class="mb-3">
          <i class="fa-solid fa-shield-halved text-primary me-2"></i>
          {{ 'Secure payment' if current_language=='en' else 'Paiement sécurisé' }}
        </h4>

        <form method="post" id="paymentForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ 'Payment service' if current_language=='en' else 'Service de paiement' }}</label>
              <select class="form-select" name="payment_service">
                <option value="MTN">MTN Mobile Money</option>
                <option value="ORANGE">Orange Money</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ 'Mobile number' if current_language=='en' else 'Numéro mobile' }}</label>
              <input type="tel" class="form-control" name="payment_phone" placeholder="6XXXXXXXX" value="{{ passenger_details.phone }}" required>
              <div class="form-text">{{ 'You will receive a prompt to approve the payment.' if current_language=='en' else 'Vous recevrez une demande pour approuver le paiement.' }}</div>
            </div>
          </div>

          <hr class="my-4">

          <div class="d-flex align-items-center justify-content-between">
            <a href="/{{ current_language }}/booking/seats?trip={{ trip.id }}" class="btn btn-outline-secondary">
              ← {{ 'Back' if current_language=='en' else 'Retour' }}
            </a>
            <button type="submit" class="btn btn-primary" id="payBtn">
              {{ 'Pay now' if current_language=='en' else 'Payer maintenant' }} — {{ '%.0f'|format(total_amount) }} XAF
            </button>
          </div>
        </form>

        <div id="feedback" class="mt-3 hidden">
          <div class="alert mb-2 status-line" role="alert"></div>
          <div class="small dim" id="subMsg"></div>
        </div>
      </div>

      <div class="alert alert-info mt-3">
        <i class="fa-solid fa-info-circle me-2"></i>
        {{ 'If your payment remains pending, you can track the status on the next page.' if current_language=='en' else 'Si votre paiement reste en attente, vous pourrez suivre le statut sur la page suivante.' }}
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card p-3">
        <h6 class="mb-2">{{ 'Booking summary' if current_language=='en' else 'Résumé de la réservation' }}</h6>
        <div class="small text-secondary">{{ trip.route.origin }} → {{ trip.route.destination }}</div>
        <div class="small">{{ 'Departure' if current_language=='en' else 'Départ' }}: {{ trip.departure_time.strftime('%d/%m/%Y %H:%M') }}</div>
        <div class="small">{{ 'Seats' if current_language=='en' else 'Places' }}: {{ selected_seats|join(', ') }}</div>
        <hr>
        <div class="d-flex align-items-center justify-content-between">
          <div>{{ 'Total' if current_language=='en' else 'Total' }}</div>
          <div class="fw-bold">{{ '%.0f'|format(total_amount) }} XAF</div>
        </div>
      </div>

      <div class="card p-3 mt-3">
        <h6 class="mb-2">{{ 'Passenger' if current_language=='en' else 'Passager' }}</h6>
        <div class="small">{{ passenger_details.name }} — {{ passenger_details.phone }}</div>
        <div class="small text-secondary">{{ passenger_details.email }}</div>
      </div>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loading">
  <div class="loading-card d-flex align-items-center gap-3">
    <div class="spinner"></div>
    <div>
      <div class="fw-semibold">{{ 'Processing payment...' if current_language=='en' else 'Traitement du paiement...' }}</div>
      <div class="small dim">{{ 'Check your phone to approve the transaction.' if current_language=='en' else 'Vérifiez votre téléphone pour approuver la transaction.' }}</div>
    </div>
  </div>
  
</div>
{% endblock %}

{% block extra_js %}
<script>
  const lang = "{{ current_language }}";
  const paymentForm = document.getElementById('paymentForm');
  const loading = document.getElementById('loading');
  const payBtn = document.getElementById('payBtn');
  const feedback = document.getElementById('feedback');
  const statusLine = feedback.querySelector('.alert');
  const subMsg = document.getElementById('subMsg');

  function showLoading(show){ loading.style.display = show ? 'flex' : 'none'; }
  function showFeedback(type, message, sub){
    feedback.classList.remove('hidden');
    statusLine.className = 'alert status-line ' + (type==='success'?'alert-success': type==='pending'?'alert-warning':'alert-danger');
    statusLine.textContent = message;
    subMsg.textContent = sub || '';
  }

  async function submitPayment(e){
    e.preventDefault();
    showLoading(true);
    payBtn.disabled = true;
    try {
      const formData = new FormData(paymentForm);
      const res = await fetch(window.location.href, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });
      const data = await res.json();
      if (data.status === 'success' || data.mesomb_status === 'SUCCESS') {
        showLoading(false);
        showFeedback('success', lang==='en'?'Payment successful! Redirecting...':'Paiement réussi ! Redirection...');
        const url = data.redirect_url || `/${lang}/booking/confirmation/${data.booking_id}`;
        setTimeout(()=> window.location.href = url, 800);
      } else if (data.status === 'pending' || data.mesomb_status === 'PENDING' || res.status === 202) {
        showLoading(false);
        showFeedback('pending', lang==='en'?'Payment pending':'Paiement en attente', data.message || (lang==='en'?'Please approve on your phone.':'Veuillez approuver sur votre téléphone.'));
        // Redirect to tracking page after a short delay
        setTimeout(()=> window.location.href = `/${lang}/booking/payment-tracking/${data.booking_id}`, 1200);
      } else {
        showLoading(false);
        showFeedback('error', data.message || (lang==='en'?'Payment failed':'Paiement échoué'));
      }
    } catch (err) {
      showLoading(false);
      showFeedback('error', lang==='en'?'An error occurred':'Une erreur s\'est produite');
    } finally {
      payBtn.disabled = false;
    }
  }

  paymentForm.addEventListener('submit', submitPayment);
</script>
{% endblock %}
