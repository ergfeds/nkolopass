<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Processing - {{ site_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .payment-tracking {
            max-width: 700px;
            margin: 50px auto;
        }
        
        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .phone-animation {
            font-size: 4rem;
            animation: pulse 2s infinite;
            margin-bottom: 20px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }
        
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e9ecef;
            z-index: 1;
        }
        
        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            height: 4px;
            background: #28a745;
            transition: width 0.5s ease;
            z-index: 2;
        }
        
        .step {
            background: white;
            border: 4px solid #e9ecef;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }
        
        .step.active {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .step.completed {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .step-label {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            white-space: nowrap;
            font-weight: 600;
        }
        
        .payment-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 1.5s infinite;
        }
        
        .status-pending { background: #ffc107; }
        .status-processing { background: #17a2b8; }
        .status-success { background: #28a745; }
        .status-failed { background: #dc3545; }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .countdown-timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: #dc3545;
        }
        
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: #17a2b8;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="payment-tracking">
            <!-- Status Card -->
            <div class="status-card">
                <div class="phone-animation">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h3>Payment Request Sent!</h3>
                <p class="mb-0">Check your phone for the payment notification</p>
                <div class="mt-3">
                    <span class="status-indicator status-pending"></span>
                    <span id="status-text">Waiting for payment approval...</span>
                </div>
            </div>
            
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="progress-line" id="progress-line" style="width: 33%;"></div>
                <div class="step completed">
                    <i class="fas fa-paper-plane"></i>
                    <div class="step-label">Request Sent</div>
                </div>
                <div class="step active" id="step-approval">
                    <i class="fas fa-mobile-alt"></i>
                    <div class="step-label">Awaiting Approval</div>
                </div>
                <div class="step" id="step-confirmation">
                    <i class="fas fa-check"></i>
                    <div class="step-label">Payment Confirmed</div>
                </div>
            </div>
            
            <!-- Payment Details -->
            <div class="payment-details">
                <h5><i class="fas fa-receipt"></i> Payment Details</h5>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Booking Reference:</strong><br>
                        <code>{{ booking.booking_reference }}</code>
                    </div>
                    <div class="col-md-6">
                        <strong>Amount:</strong><br>
                        <span class="text-success">{{ "{:,.0f}".format(booking.total_amount) }} FCFA</span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Route:</strong><br>
                        {{ booking.trip.route.origin }} â†’ {{ booking.trip.route.destination }}
                    </div>
                    <div class="col-md-6">
                        <strong>Departure:</strong><br>
                        {{ booking.trip.departure_time.strftime('%d/%m/%Y at %H:%M') }}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Passenger:</strong><br>
                        {{ booking.customer.name }}
                    </div>
                    <div class="col-md-6">
                        <strong>Seats:</strong><br>
                        {% for seat in booking.get_seat_numbers() %}
                            <span class="badge bg-primary">{{ seat }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="instructions">
                <h6><i class="fas fa-info-circle"></i> What to do next:</h6>
                <ol class="mb-0">
                    <li>Check your mobile phone for a payment notification</li>
                    <li>Open your MTN Mobile Money or Orange Money app</li>
                    <li>Approve the payment request for <strong>{{ "{:,.0f}".format(booking.total_amount) }} FCFA</strong></li>
                    <li>Your booking will be automatically confirmed</li>
                </ol>
            </div>
            
            <!-- Timer and Actions -->
            <div class="text-center">
                <div class="countdown-timer mb-3">
                    <i class="fas fa-clock"></i> 
                    Time remaining: <span id="countdown">02:00</span>
                </div>
                
                <button onclick="checkPaymentStatus()" class="refresh-btn me-2">
                    <i class="fas fa-sync-alt"></i> Check Status
                </button>
                
                <a href="{{ url_for('user.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-home"></i> Back to Home
                </a>
            </div>
            
            <!-- Status Messages -->
            <div id="status-messages" class="mt-4"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let checkInterval;
        let countdownInterval;
        let timeRemaining = 120; // 2 minutes in seconds
        let checkCount = 0;
        const maxChecks = 120; // Check for 2 minutes
        
        // Start checking payment status
        function startPaymentTracking() {
            checkInterval = setInterval(checkPaymentStatus, 1000); // Check every second
            countdownInterval = setInterval(updateCountdown, 1000);
        }
        
        // Check payment status
        function checkPaymentStatus() {
            checkCount++;
            
            fetch(`/api/payment-status/{{ booking.id }}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                updatePaymentStatus(data);
                
                if (data.is_confirmed) {
                    // Payment confirmed, redirect to confirmation page
                    clearInterval(checkInterval);
                    clearInterval(countdownInterval);
                    showSuccessMessage();
                    setTimeout(() => {
                        window.location.href = `/booking/confirmation/${data.booking_id}`;
                    }, 2000);
                } else if (data.payment_status === 'failed') {
                    clearInterval(checkInterval);
                    clearInterval(countdownInterval);
                    showFailedMessage();
                } else if (data.payment_status === 'expired') {
                    clearInterval(checkInterval);
                    clearInterval(countdownInterval);
                    showExpiredMessage();
                } else if (checkCount >= maxChecks) {
                    clearInterval(checkInterval);
                    clearInterval(countdownInterval);
                    showTimeoutMessage();
                }
            })
            .catch(error => {
                console.error('Error checking payment status:', error);
                if (checkCount >= maxChecks) {
                    clearInterval(checkInterval);
                    clearInterval(countdownInterval);
                    showTimeoutMessage();
                }
            });
        }
        
        // Update payment status display
        function updatePaymentStatus(data) {
            const statusText = document.getElementById('status-text');
            const statusIndicator = document.querySelector('.status-indicator');
            const progressLine = document.getElementById('progress-line');
            const stepApproval = document.getElementById('step-approval');
            const stepConfirmation = document.getElementById('step-confirmation');
            
            if (data.payment_status === 'pending') {
                statusText.textContent = 'Waiting for payment approval...';
                statusIndicator.className = 'status-indicator status-pending';
                progressLine.style.width = '33%';
            } else if (data.payment_status === 'paid' || data.is_confirmed) {
                statusText.textContent = 'Payment successful! Confirming booking...';
                statusIndicator.className = 'status-indicator status-success';
                progressLine.style.width = '100%';
                stepApproval.classList.add('completed');
                stepApproval.classList.remove('active');
                stepConfirmation.classList.add('active');
            }
        }
        
        // Show success message
        function showSuccessMessage() {
            document.getElementById('status-text').textContent = 'Payment confirmed! Redirecting...';
            document.querySelector('.status-indicator').className = 'status-indicator status-success';
            
            const messageDiv = document.getElementById('status-messages');
            messageDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <strong>Success!</strong> Your payment has been confirmed. Redirecting to your ticket...
                </div>
            `;
        }
        
        // Show failed message
        function showFailedMessage() {
            document.getElementById('status-text').textContent = 'Payment failed';
            document.querySelector('.status-indicator').className = 'status-indicator status-failed';
            
            const messageDiv = document.getElementById('status-messages');
            messageDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i>
                    <strong>Payment Failed:</strong> Your payment was not successful. 
                    <a href="{{ url_for('user.payment') }}" class="alert-link">Click here to try again</a>
                </div>
            `;
        }
        
        // Show expired message
        function showExpiredMessage() {
            document.getElementById('status-text').textContent = 'Payment expired';
            document.querySelector('.status-indicator').className = 'status-indicator status-failed';
            
            const messageDiv = document.getElementById('status-messages');
            messageDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-clock"></i>
                    <strong>Payment Expired:</strong> The payment request has expired. 
                    <a href="{{ url_for('user.payment') }}" class="alert-link">Click here to try again</a>
                </div>
            `;
        }
        
        // Update countdown timer
        function updateCountdown() {
            timeRemaining--;
            
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            
            document.getElementById('countdown').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeRemaining <= 0) {
                clearInterval(countdownInterval);
                clearInterval(checkInterval);
                showTimeoutMessage();
            }
        }
        
        // Show timeout message
        function showTimeoutMessage() {
            document.getElementById('status-text').textContent = 'Payment timeout - Please try again';
            document.querySelector('.status-indicator').className = 'status-indicator status-failed';
            
            const messageDiv = document.getElementById('status-messages');
            messageDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Payment Timeout:</strong> The payment request has expired. 
                    <a href="{{ url_for('user.payment') }}" class="alert-link">Click here to try again</a>
                </div>
            `;
        }
        
        // Start tracking when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startPaymentTracking();
        });
        
        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', function() {
            if (checkInterval) clearInterval(checkInterval);
            if (countdownInterval) clearInterval(countdownInterval);
        });
    </script>
</body>
</html>
