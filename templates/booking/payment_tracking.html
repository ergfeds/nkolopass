{% extends 'base.html' %}
{% block title %}{{ 'Payment Tracking' if current_language=='en' else 'Suivi du paiement' }} — {{ site_name }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card p-3 p-md-4">
        <h4 class="mb-2">
          <i class="fa-solid fa-spinner text-primary me-2"></i>
          {{ 'We are tracking your payment...' if current_language=='en' else 'Nous suivons votre paiement...' }}
        </h4>
        <p class="text-secondary mb-4">
          {{ 'This page will update once the payment is confirmed. You can also check manually.' if current_language=='en' else 'Cette page se mettra à jour une fois le paiement confirmé. Vous pouvez aussi vérifier manuellement.' }}
        </p>

        <div class="d-flex gap-2">
          <a class="btn btn-primary" id="checkNowBtn" href="/{{ current_language }}/booking/status/{{ booking.id }}">
            <i class="fa-solid fa-rotate me-2"></i>{{ 'Check status now' if current_language=='en' else 'Vérifier maintenant' }}
          </a>
          <a class="btn btn-outline-secondary" href="/{{ current_language }}/">
            {{ 'Back to Home' if current_language=='en' else 'Retour à l\'accueil' }}
          </a>
        </div>

        <div class="alert alert-info mt-3 d-flex align-items-center gap-2" id="infoBox" role="alert">
          <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
          <span id="infoText">{{ 'Waiting for mobile confirmation on your device. Approve the prompt to complete payment.' if current_language=='en' else 'En attente de la confirmation sur votre téléphone. Validez la demande pour finaliser le paiement.' }}</span>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card p-3">
        <h6 class="mb-2">{{ 'Booking' if current_language=='en' else 'Réservation' }}</h6>
        <div class="small"><strong>#{{ booking.booking_reference }}</strong></div>
        <div class="small text-secondary">{{ booking.trip.route.origin }} → {{ booking.trip.route.destination }}</div>
        <div class="small">{{ booking.trip.departure_time.strftime('%d/%m/%Y %H:%M') }}</div>
        <div class="small">{{ 'Amount' if current_language=='en' else 'Montant' }}: {{ '%.0f'|format(booking.total_amount) }} XAF</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const lang = "{{ current_language }}";
  const bookingId = Number("{{ booking.id }}");
  const statusUrl = `/api/payment-status/${bookingId}`;
  const confirmUrl = `/${lang}/booking/confirmation/${bookingId}`;
  const manualCheckUrl = document.getElementById('checkNowBtn').getAttribute('href');
  const infoBox = document.getElementById('infoBox');
  const infoText = document.getElementById('infoText');

  function setInfo(type, message) {
    infoBox.classList.remove('alert-info','alert-success','alert-warning','alert-danger');
    infoBox.classList.add(type);
    infoText.textContent = message;
  }

  let checkCount = 0;
  let maxChecks = 12; // Maximum 12 checks over 2 minutes (every 10 seconds)
  let timer;
  let startTime = Date.now();

  async function checkForSuccess(){
    try {
      checkCount++;
      const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
      const remainingSeconds = Math.max(0, 120 - elapsedSeconds);
      
      const waitingMsg = lang === 'en' 
        ? `Waiting for payment confirmation... (${Math.ceil(remainingSeconds / 60)} min ${remainingSeconds % 60}s remaining)`
        : `En attente de la confirmation de paiement... (${Math.ceil(remainingSeconds / 60)} min ${remainingSeconds % 60}s restantes)`;
      
      const res = await fetch(statusUrl, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      
      console.log(`Check ${checkCount} (${elapsedSeconds}s):`, data);
      
      // PRIMARY FOCUS: Check for SUCCESS
      if (data.payment_status === 'paid' || data.booking_status === 'confirmed' || data.is_confirmed) {
        setInfo('alert-success', lang==='en' ? 'Payment successful! Redirecting to your ticket...' : 'Paiement réussi ! Redirection vers votre billet...');
        clearTimeout(timer);
        setTimeout(()=> window.location.href = confirmUrl, 1500);
        return;
      }
      
      // Continue waiting if still within 120 seconds
      if (remainingSeconds > 0) {
        setInfo('alert-info', waitingMsg);
        
        // Schedule next check (every 10 seconds)
        timer = setTimeout(checkForSuccess, 10000);
      } else {
        // After 120 seconds, show timeout message but don't mark as failed
        setInfo('alert-warning', lang==='en' 
          ? 'MeSomb response window completed. Please check manually if payment was deducted or contact support.'
          : 'Fenêtre de réponse MeSomb terminée. Veuillez vérifier manuellement si le paiement a été débité ou contacter le support.');
      }
      
    } catch (e) {
      console.error('Status check error:', e);
      
      // On network error, keep trying if within time window
      const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
      if (elapsedSeconds < 120) {
        setInfo('alert-info', lang==='en' 
          ? 'Network issue, retrying... Please keep this page open.'
          : 'Problème réseau, nouvelle tentative... Veuillez garder cette page ouverte.');
        timer = setTimeout(checkForSuccess, 15000); // Retry after 15 seconds on error
      }
    }
  }

  // Initial message and start checking after 20 seconds
  setInfo('alert-info', lang==='en' 
    ? 'Please check your phone for the payment request and approve it. MeSomb will respond within 2 minutes...'
    : 'Veuillez vérifier votre téléphone pour la demande de paiement et l\'approuver. MeSomb répondra dans les 2 minutes...');
  
  // Start first check after 20 seconds to give user time to see and approve the payment
  timer = setTimeout(checkForSuccess, 20000);
</script>
{% endblock %}
