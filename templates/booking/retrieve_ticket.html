{% extends 'base.html' %}
{% block title %}{{ 'Retrieve Tickets' if current_language=='en' else 'Récupérer les tickets' }} — {{ site_name }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card p-3 p-md-4">
        <h5 class="mb-3">{{ 'Find your tickets' if current_language=='en' else 'Retrouvez vos tickets' }}</h5>
        <form id="retrieveForm" class="row g-3">
          <div class="col-12">
            <label class="form-label">{{ 'Search by' if current_language=='en' else 'Rechercher par' }}</label>
            <select class="form-select" id="method">
              <option value="phone">{{ 'Phone' if current_language=='en' else 'Téléphone' }}</option>
              <option value="email">Email</option>
              <option value="reference">{{ 'Booking reference' if current_language=='en' else 'Référence de réservation' }}</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">{{ 'Value' if current_language=='en' else 'Valeur' }}</label>
            <input type="text" class="form-control" id="value" placeholder="e.g. 6XXXXXXXX / name@example.com / NKPABC123" required>
          </div>
          <div class="col-12 d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="fa-solid fa-magnifying-glass me-2"></i>{{ 'Search' if current_language=='en' else 'Rechercher' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card p-3 p-md-4">
        <h6 class="mb-3">{{ 'Results' if current_language=='en' else 'Résultats' }}</h6>
        <div id="results"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const resultsEl = document.getElementById('results');
  document.getElementById('retrieveForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const method = document.getElementById('method').value;
    const value = document.getElementById('value').value.trim();
    if (!value) return;
    const url = new URL('/api/retrieve-tickets', window.location.origin);
    url.searchParams.set('method', method);
    url.searchParams.set('value', value);
    resultsEl.innerHTML = '<div class="text-secondary">Loading...</div>';
    try {
      const res = await fetch(url);
      const data = await res.json();
      const tickets = data.tickets || [];
      if (!tickets.length) {
        resultsEl.innerHTML = '<div class="alert alert-warning">No tickets found.</div>';
        return;
      }
      resultsEl.innerHTML = tickets.map(t => `
        <div class="border rounded p-3 mb-2">
          <div class="d-flex align-items-center justify-content-between">
            <div><strong>#${t.reference}</strong> — ${t.route}</div>
            <div class="fw-bold">${(t.amount||0).toLocaleString()} XAF</div>
          </div>
          <div class="text-secondary small">${t.date} · ${t.time} · ${t.seats.join(', ')}</div>
        </div>
      `).join('');
    } catch (e) {
      resultsEl.innerHTML = '<div class="alert alert-danger">Error loading results.</div>';
    }
  });
</script>
{% endblock %}
