{% extends "admin/base.html" %}

{% block title %}{{ route.name }} - Operator Assignments - Nkolo Pass Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 mb-0">
                        <i class="fas fa-users me-2"></i>Operator Assignments
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-route me-1"></i>
                        <strong>{{ route.name }}</strong>: {{ route.origin }} â†’ {{ route.destination }}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                        <i class="fas fa-plus me-1"></i>Assign Operators
                    </button>
                    <a href="{{ url_for('admin_bp.routes') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Routes
                    </a>
                </div>
            </div>

            <!-- Route Summary Card -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-road text-primary me-2"></i>
                                        <div>
                                            <small class="text-muted">Distance</small>
                                            <div class="fw-bold">
                                                {% if route.distance_km %}{{ "%.1f".format(route.distance_km) }} km{% else %}N/A{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-clock text-warning me-2"></i>
                                        <div>
                                            <small class="text-muted">Duration</small>
                                            <div class="fw-bold">
                                                {% if route.estimated_duration %}
                                                    {{ (route.estimated_duration // 60) }}h {{ (route.estimated_duration % 60) }}m
                                                {% else %}N/A{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-money-bill text-success me-2"></i>
                                        <div>
                                            <small class="text-muted">Price Range</small>
                                            <div class="fw-bold">
                                                {% set assignments = route.operator_assignments %}
                                                {% if assignments %}
                                                    {% set min_regular = assignments|map(attribute='regular_seat_price')|select('greaterthan', 0)|list|min %}
                                                    {% set max_vip = assignments|map(attribute='vip_seat_price')|select('greaterthan', 0)|list|max %}
                                                    {% if min_regular and max_vip %}
                                                        {{ "{:,.0f}".format(min_regular) }} - {{ "{:,.0f}".format(max_vip) }} FCFA
                                                    {% elif min_regular %}
                                                        From {{ "{:,.0f}".format(min_regular) }} FCFA
                                                    {% else %}
                                                        <span class="text-muted">Not set</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">No operators</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-building text-info me-2"></i>
                                        <div>
                                            <small class="text-muted">Assigned Operators</small>
                                            <div class="fw-bold">{{ assignments|length }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignments Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Operator Assignments</h5>
                    {% if assignments %}
                    <span class="badge bg-primary">{{ assignments|length }} assignments</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if assignments %}
                    <div class="table-responsive">
                        <table id="assignmentsTable" class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Operator</th>
                                    <th>Locations</th>
                                    <th>Regular Price</th>
                                    <th>VIP Price</th>
                                    <th>Service Days</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assignment in assignments %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if assignment.operator.logo %}
                                            <img src="{{ url_for('static', filename='uploads/logos/' + assignment.operator.logo) }}" 
                                                 alt="{{ assignment.operator.name }}" class="rounded me-2" style="width: 32px; height: 32px;">
                                            {% else %}
                                            <div class="bg-primary rounded d-flex align-items-center justify-content-center me-2" 
                                                 style="width: 32px; height: 32px;">
                                                <i class="fas fa-building text-white"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-bold">{{ assignment.operator.name }}</div>
                                                <small class="text-muted">{{ assignment.operator.code }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if assignment.pickup_location or assignment.dropoff_location %}
                                            <div class="small">
                                                {% if assignment.pickup_location %}
                                                    <div class="mb-1">
                                                        <i class="fas fa-arrow-up text-success me-1"></i>
                                                        <strong>Pickup:</strong> {{ assignment.pickup_location.city }}
                                                        <br><small class="text-muted ms-3">{{ assignment.pickup_location.address[:40] }}{% if assignment.pickup_location.address|length > 40 %}...{% endif %}</small>
                                                    </div>
                                                {% endif %}
                                                {% if assignment.dropoff_location %}
                                                    <div>
                                                        <i class="fas fa-arrow-down text-warning me-1"></i>
                                                        <strong>Dropoff:</strong> {{ assignment.dropoff_location.city }}
                                                        <br><small class="text-muted ms-3">{{ assignment.dropoff_location.address[:40] }}{% if assignment.dropoff_location.address|length > 40 %}...{% endif %}</small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted small">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Not specified
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="fw-bold text-success">
                                            {% if assignment.regular_price %}
                                                {% if assignment.regular_price is not none and assignment.regular_price > 0 %}
                                                    {% set reg_price = assignment.regular_price|float %}
                                                    {{ "{:,.0f}".format(reg_price) }} FCFA
                                                {% else %}
                                                    <span class="text-muted">Not set</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">Not set</span>
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if assignment.vip_price %}
                                            {% if assignment.vip_price is not none and assignment.vip_price > 0 %}
                                                <span class="fw-bold text-warning">
                                                    {% set vip_price = assignment.vip_price|float %}
                                                    {{ "{:,.0f}".format(vip_price) }} FCFA
                                                </span>
                                            {% else %}
                                                <span class="text-muted">Same as regular</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Same as regular</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="service-days">
                                            {% set day_names = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                                            {% set service_days = assignment.get_service_days_list() %}
                                            {% for i in range(7) %}
                                                {% if (i + 1) in service_days %}
                                                    <span class="badge bg-success">{{ day_names[i] }}</span>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">{{ day_names[i] }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if assignment.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteAssignment({{ assignment.id }}, '{{ assignment.operator.name }}')" 
                                                title="Remove Assignment">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No operators assigned to this route</h5>
                        <p class="text-muted">Assign operators to this route to enable trip generation and booking.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignModal">
                            <i class="fas fa-plus me-1"></i>Assign Operators
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Operator Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Operator to Route</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_bp.assign_route_operator', route_id=route.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="operator_id" class="form-label">Select Operator</label>
                                <select class="form-select" id="operator_id" name="operator_id" required>
                                    <option value="">Choose an operator...</option>
                                    {% for operator in operators %}
                                    <option value="{{ operator.id }}">{{ operator.name }} ({{ operator.code }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="trips_per_day" class="form-label">Trips Per Day</label>
                                <input type="number" class="form-control" id="trips_per_day" name="trips_per_day" 
                                       min="1" max="10" value="3" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="regular_seat_price" class="form-label">Regular Seat Price (FCFA)</label>
                                <input type="number" class="form-control" id="regular_seat_price" name="regular_seat_price" 
                                       min="100" step="100" value="3000" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="vip_seat_price" class="form-label">VIP Seat Price (FCFA)</label>
                                <input type="number" class="form-control" id="vip_seat_price" name="vip_seat_price" 
                                       min="100" step="100" value="5000" required>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> The operator must have configured bus types (VIP/Regular) before being assigned to routes.
                        You can configure bus types in the <a href="{{ url_for('admin_bp.operators') }}">Operators</a> section.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Operator</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Assignment Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Operator Assignment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove "<span id="operatorName"></span>" from this route?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will prevent the operator from creating new trips on this route.
                    Existing trips will not be affected.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Remove Assignment</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Check if table exists before initializing DataTables
    if ($('#assignmentsTable').length) {
        // Check if DataTable is already initialized and destroy it first
        if ($.fn.DataTable.isDataTable('#assignmentsTable')) {
            $('#assignmentsTable').DataTable().destroy();
        }
        
        $('#assignmentsTable').DataTable({
            responsive: true,
            order: [[0, 'asc']],
            pageLength: 10,
            columnDefs: [
                { orderable: false, targets: [6] } // Disable sorting on Actions column
            ],
            language: {
                search: "Search assignments:",
                lengthMenu: "Show _MENU_ assignments per page",
                info: "Showing _START_ to _END_ of _TOTAL_ assignments",
                infoEmpty: "No assignments available",
                zeroRecords: "No matching assignments found"
            }
        });
    }

    // Disable backdrop for assign modal
    $('#assignModal').on('show.bs.modal', function () {
        $(this).data('bs.modal')._config.backdrop = false;
    });
});

function deleteAssignment(assignmentId, operatorName) {
    document.getElementById('operatorName').textContent = operatorName;
    document.getElementById('deleteForm').action = '/admin/routes/operators/' + assignmentId + '/delete';
    new bootstrap.Modal(document.getElementById('deleteModal'), {
        backdrop: false
    }).show();
}
</script>

<style>
.service-days .badge {
    margin-right: 2px;
    margin-bottom: 2px;
    font-size: 0.7em;
}
</style>
{% endblock %}
