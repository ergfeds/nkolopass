{% extends "admin/base.html" %}

{% block title %}{{ operator.name }} - {{ config.bus_type.name }} Seat Map - Nkolo Pass Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="h4 mb-0">
                        <i class="fas fa-th me-2"></i>Seat Map Editor
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-building me-1"></i>
                        <strong>{{ operator.name }}</strong> - {{ config.bus_type.name }}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success" id="saveSeatMap">
                        <i class="fas fa-save me-1"></i>Save Layout
                    </button>
                    <a href="{{ url_for('admin_bp.operator_bus_types', operator_id=operator.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Bus Types
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- Seat Map Editor -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-bus me-2"></i>Bus Layout
                                </h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary" id="resetLayout">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="autoArrange">
                                        <i class="fas fa-magic"></i> Auto Arrange
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Bus Front Indicator -->
                            <div class="bus-front mb-3">
                                <div class="front-indicator">
                                    <i class="fas fa-steering-wheel"></i> FRONT
                                </div>
                            </div>

                            <!-- Seat Map Container -->
                            <div id="seatMapContainer" class="seat-map-container">
                                <!-- Seats will be dynamically generated here -->
                            </div>

                            <!-- Bus Back -->
                            <div class="bus-back mt-3">
                                <div class="back-indicator">
                                    BACK
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controls Panel -->
                <div class="col-lg-4">
                    <!-- Configuration Info -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>Configuration
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="stat-item">
                                        <h5 class="mb-0 text-primary" id="totalSeats">{{ config.capacity }}</h5>
                                        <small class="text-muted">Total Seats</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-item">
                                        <h5 class="mb-0 text-success">{{ config.seats_per_row }}</h5>
                                        <small class="text-muted">Per Row</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seat Types -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-palette me-2"></i>Seat Types
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="seat-types">
                                <div class="seat-type-item mb-2" data-type="standard">
                                    <div class="seat-preview standard"></div>
                                    <span>Standard Seat</span>
                                </div>
                                <div class="seat-type-item mb-2" data-type="premium">
                                    <div class="seat-preview premium"></div>
                                    <span>Premium Seat</span>
                                </div>
                                <div class="seat-type-item mb-2" data-type="disabled">
                                    <div class="seat-preview disabled"></div>
                                    <span>Disabled/Blocked</span>
                                </div>
                                <div class="seat-type-item mb-2" data-type="aisle">
                                    <div class="seat-preview aisle"></div>
                                    <span>Aisle Space</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-question-circle me-2"></i>How to Use
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled small">
                                <li class="mb-2"><i class="fas fa-mouse-pointer text-primary me-2"></i>Click a seat type, then click seats to change them</li>
                                <li class="mb-2"><i class="fas fa-arrows-alt text-success me-2"></i>Drag seats to rearrange layout</li>
                                <li class="mb-2"><i class="fas fa-magic text-warning me-2"></i>Use "Auto Arrange" for default layout</li>
                                <li class="mb-2"><i class="fas fa-save text-info me-2"></i>Don't forget to save your changes</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Seat Statistics
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="seat-stats">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Standard:</span>
                                    <span id="standardCount">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Premium:</span>
                                    <span id="premiumCount">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Disabled:</span>
                                    <span id="disabledCount">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Aisle Spaces:</span>
                                    <span id="aisleCount">0</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Available Seats:</span>
                                    <span id="availableCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.seat-map-container {
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 15px;
    padding: 20px;
    min-height: 400px;
    position: relative;
}

.bus-front, .bus-back {
    text-align: center;
}

.front-indicator, .back-indicator {
    background: #6c757d;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    display: inline-block;
    font-size: 0.9rem;
    font-weight: bold;
}

.front-indicator {
    background: #007bff;
}

.seat-row {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
    gap: 5px;
}

.seat {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: bold;
    transition: all 0.2s ease;
    position: relative;
    user-select: none;
}

.seat:hover {
    transform: scale(1.1);
    z-index: 10;
}

.seat.standard {
    background: #28a745;
    color: white;
    border: 2px solid #1e7e34;
}

.seat.premium {
    background: #ffc107;
    color: #212529;
    border: 2px solid #d39e00;
}

.seat.disabled {
    background: #6c757d;
    color: white;
    border: 2px solid #495057;
}

.seat.aisle {
    background: transparent;
    border: 2px dashed #dee2e6;
    color: #6c757d;
}

.seat.selected {
    box-shadow: 0 0 0 3px rgba(0,123,255,0.5);
}

.seat-types {
    display: flex;
    flex-direction: column;
}

.seat-type-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s ease;
}

.seat-type-item:hover {
    background: #f8f9fa;
}

.seat-type-item.active {
    background: #e3f2fd;
    border: 1px solid #2196f3;
}

.seat-preview {
    width: 30px;
    height: 30px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
}

.seat-preview.standard {
    background: #28a745;
    color: white;
    border: 2px solid #1e7e34;
}

.seat-preview.premium {
    background: #ffc107;
    color: #212529;
    border: 2px solid #d39e00;
}

.seat-preview.disabled {
    background: #6c757d;
    color: white;
    border: 2px solid #495057;
}

.seat-preview.aisle {
    background: transparent;
    border: 2px dashed #dee2e6;
}

.stat-item {
    padding: 0.5rem 0;
}

.seat-stats {
    font-size: 0.9rem;
}

.aisle-space {
    width: 20px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.aisle-space::after {
    content: '';
    width: 3px;
    height: 30px;
    background: linear-gradient(135deg, #dee2e6 0%, #adb5bd 100%);
    border-radius: 2px;
}

@media (max-width: 768px) {
    .seat {
        width: 35px;
        height: 35px;
        font-size: 0.7rem;
    }
    
    .seat-row {
        gap: 3px;
        margin-bottom: 8px;
    }
    
    .seat-map-container {
        padding: 15px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentSeatType = 'standard';
let seatLayout = [];
let config = {
    capacity: {{ config.capacity }},
    seatsPerRow: {{ config.seats_per_row }},
    operatorId: {{ operator.id }},
    configId: {{ config.id }}
};

// Load existing layout or generate default
let existingLayout = {{ config.get_seat_layout()|tojson }};

$(document).ready(function() {
    initializeSeatMap();
    bindEvents();
    updateStatistics();
});

function initializeSeatMap() {
    if (existingLayout && existingLayout.length > 0) {
        seatLayout = existingLayout;
    } else {
        generateDefaultLayout();
    }
    renderSeatMap();
}

function generateDefaultLayout() {
    seatLayout = [];
    const rows = Math.ceil(config.capacity / config.seatsPerRow);
    let seatNumber = 1;
    
    for (let r = 0; r < rows; r++) {
        let row = [];
        let seatsInRow = Math.min(config.seatsPerRow, config.capacity - (r * config.seatsPerRow));
        
        for (let s = 0; s < seatsInRow; s++) {
            row.push({
                number: seatNumber,
                position: String.fromCharCode(65 + s), // A, B, C, D...
                type: 'standard'
            });
            seatNumber++;
        }
        seatLayout.push(row);
    }
}

function renderSeatMap() {
    const container = $('#seatMapContainer');
    container.empty();
    
    seatLayout.forEach((row, rowIndex) => {
        const rowDiv = $('<div class="seat-row"></div>');
        
        row.forEach((seat, seatIndex) => {
            const seatDiv = $(`
                <div class="seat ${seat.type}" 
                     data-row="${rowIndex}" 
                     data-seat="${seatIndex}"
                     title="Seat ${seat.number}">
                    ${seat.number}
                </div>
            `);
            
            seatDiv.click(function() {
                changeSeatType(rowIndex, seatIndex);
            });
            
            rowDiv.append(seatDiv);
            
            // Add aisle space with proper positioning
            const hasAisle = row.length >= 3;
            let aislePosition;
            if (row.length === 4) {
                aislePosition = 1; // After 2nd seat (left side gets 2, right side gets 2)
            } else if (row.length === 5) {
                aislePosition = 2; // After 3rd seat (left side gets 3, right side gets 2)  
            } else if (row.length === 3) {
                aislePosition = 1; // After 2nd seat (left side gets 2, right side gets 1)
            } else {
                aislePosition = Math.floor(row.length / 2) - 1;
            }
            
            if (hasAisle && seatIndex === aislePosition) {
                rowDiv.append('<div class="aisle-space"></div>');
            }
        });
        
        container.append(rowDiv);
    });
    
    updateStatistics();
}

function changeSeatType(rowIndex, seatIndex) {
    seatLayout[rowIndex][seatIndex].type = currentSeatType;
    renderSeatMap();
}

function bindEvents() {
    // Seat type selection
    $('.seat-type-item').click(function() {
        $('.seat-type-item').removeClass('active');
        $(this).addClass('active');
        currentSeatType = $(this).data('type');
    });
    
    // Set default active seat type
    $('.seat-type-item[data-type="standard"]').addClass('active');
    
    // Reset layout
    $('#resetLayout').click(function() {
        if (confirm('Are you sure you want to reset the seat layout? This will remove all customizations.')) {
            generateDefaultLayout();
            renderSeatMap();
        }
    });
    
    // Auto arrange
    $('#autoArrange').click(function() {
        autoArrangeSeats();
    });
    
    // Save seat map
    $('#saveSeatMap').click(function() {
        saveSeatMap();
    });
}

function autoArrangeSeats() {
    // Create a balanced layout with premium seats at front and back
    seatLayout.forEach((row, rowIndex) => {
        row.forEach((seat, seatIndex) => {
            if (rowIndex < 2 || rowIndex >= seatLayout.length - 2) {
                // Front and back rows are premium
                seat.type = 'premium';
            } else {
                // Middle rows are standard
                seat.type = 'standard';
            }
            
            // Add aisle space in the middle for wider buses
            if (config.seatsPerRow >= 4 && seatIndex === Math.floor(config.seatsPerRow / 2)) {
                // This could be enhanced to add actual aisle spaces
            }
        });
    });
    
    renderSeatMap();
}

function updateStatistics() {
    let stats = {
        standard: 0,
        premium: 0,
        disabled: 0,
        aisle: 0
    };
    
    seatLayout.forEach(row => {
        row.forEach(seat => {
            stats[seat.type]++;
        });
    });
    
    $('#standardCount').text(stats.standard);
    $('#premiumCount').text(stats.premium);
    $('#disabledCount').text(stats.disabled);
    $('#aisleCount').text(stats.aisle);
    $('#availableCount').text(stats.standard + stats.premium);
    $('#totalSeats').text(stats.standard + stats.premium + stats.disabled);
}

function saveSeatMap() {
    const saveBtn = $('#saveSeatMap');
    const originalText = saveBtn.html();
    
    saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Saving...');
    
    $.ajax({
        url: `/admin/operators/${config.operatorId}/bus-types/${config.configId}/seat-map`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            seatLayout: seatLayout,
            capacity: $('#totalSeats').text()
        }),
        success: function(response) {
            if (response.success) {
                // Show success message
                const alert = $(`
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>${response.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `);
                $('.container-fluid').prepend(alert);
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    alert.alert('close');
                }, 3000);
            }
        },
        error: function(xhr, status, error) {
            const alert = $(`
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error saving seat map. Please try again.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            $('.container-fluid').prepend(alert);
        },
        complete: function() {
            saveBtn.prop('disabled', false).html(originalText);
        }
    });
}
</script>
{% endblock %}
