{% extends 'base.html' %}
{% block title %}{{ site_name }} ‚Äî Book Your Trip{% endblock %}

{% block extra_css %}
<style>
  .hero {
    position: relative;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    overflow: hidden;
  }
  
  .hero::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="white" opacity="0.1"><path d="M0,0v46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1047.71,5.4,1100.08,25.29V0Z"></path></svg>') repeat-x;
    background-size: 1000px 100px;
    animation: wave 20s linear infinite;
  }
  
  @keyframes wave {
    0% { transform: translateX(0); }
    100% { transform: translateX(-1000px); }
  }
  
  .hero-content {
    position: relative;
    z-index: 2;
  }
  
  .hero-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    border-radius: 20px;
    color: #333;
  }
  
  .floating-badge {
    position: absolute; 
    right: 1rem; 
    top: -0.75rem;
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  .operator-logo { 
    height: 26px; 
    width: auto; 
  }
  
  .feature-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    margin: 0 auto 1rem;
  }
  
  .stats-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 2rem;
    text-align: center;
    color: white;
  }
  
  .stats-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #ffd700;
  }
  
  .popular-trips-card {
    border: none;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border-radius: 15px;
    transition: transform 0.3s ease;
  }
  
  .popular-trips-card:hover {
    transform: translateY(-5px);
  }
  
  .section-title {
    position: relative;
    display: inline-block;
    margin-bottom: 3rem;
  }
  
  .section-title::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 4px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 2px;
  }
  
  .cta-section {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
  }
  
  .btn-gradient {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    color: white;
  }
</style>
{% endblock %}

{% block content %}
<section class="hero py-5">
  <div class="container py-4 hero-content">
    <div class="row align-items-center g-4">
      <div class="col-lg-6">
        <div class="mb-3">
          <span class="badge bg-warning text-dark px-3 py-2 rounded-pill">
            <i class="fas fa-star me-1"></i>{{ '#1 Bus Booking Platform' if current_language=='en' else 'Plateforme N¬∞1 de R√©servation' }}
          </span>
        </div>
        <h1 class="display-4 fw-bold mb-4">
          {{ 'Travel Smart Across' if current_language=='en' else 'Voyagez Malin √† Travers le' }}
          <span class="text-warning">{{ 'Cameroon' if current_language=='en' else 'Cameroun' }}</span> üá®üá≤
        </h1>
        <p class="fs-5 mb-4 opacity-90">
          {{ 'Compare routes, operators, and prices. Book seats instantly with Mobile Money and get your e-ticket immediately.' if current_language=='en' else 'Comparez les trajets, agences et prix. R√©servez instantan√©ment via Mobile Money et recevez votre e-ticket imm√©diatement.' }}
        </p>
        
        <!-- Stats Row -->
        <div class="row g-3 mb-4">
          <div class="col-4">
            <div class="stats-card">
              <div class="stats-number">50+</div>
              <small>{{ 'Routes' if current_language=='en' else 'Trajets' }}</small>
            </div>
          </div>
          <div class="col-4">
            <div class="stats-card">
              <div class="stats-number">20+</div>
              <small>{{ 'Operators' if current_language=='en' else 'Agences' }}</small>
            </div>
          </div>
          <div class="col-4">
            <div class="stats-card">
              <div class="stats-number">24/7</div>
              <small>{{ 'Support' if current_language=='en' else 'Support' }}</small>
            </div>
          </div>
        </div>
        
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <a href="#searchForm" class="btn btn-gradient btn-lg">
            <i class="fas fa-search me-2"></i>{{ 'Book Now' if current_language=='en' else 'R√©server Maintenant' }}
          </a>
          <div class="d-flex align-items-center text-white-50">
            <div class="me-3">
              <i class="fas fa-shield-alt text-success fs-5 me-2"></i>
              <small>{{ 'Secure Payment' if current_language=='en' else 'Paiement S√©curis√©' }}</small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card hero-card p-3 p-md-4">
          <div class="position-relative">
            <span class="badge bg-primary floating-badge">{{ 'New' if current_language=='en' else 'Nouveau' }}</span>
          </div>
          <form id="searchForm" class="mt-2">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">{{ 'From' if current_language=='en' else 'De' }}</label>
                <select class="form-select" id="fromCity" required></select>
              </div>
              <div class="col-md-6">
                <label class="form-label">{{ 'To' if current_language=='en' else '√Ä' }}</label>
                <select class="form-select" id="toCity" required></select>
              </div>
              <div class="col-md-6">
                <label class="form-label">{{ 'Date' if current_language=='en' else 'Date' }}</label>
                <input type="date" class="form-control" id="travelDate" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">{{ 'Agency *' if current_language=='en' else 'Agence *' }}</label>
                <select class="form-select" id="operatorSelect" required></select>
              </div>
              <div class="col-12 d-grid d-md-flex gap-2 mt-2">
                <button type="submit" class="btn btn-primary px-4"><i class="fa-solid fa-magnifying-glass me-2"></i>{{ 'Search trips' if current_language=='en' else 'Rechercher des trajets' }}</button>
                <a class="btn btn-outline-secondary" href="/{{ current_language }}/bookings"><i class="fa-solid fa-ticket me-2"></i>{{ 'My bookings' if current_language=='en' else 'Mes r√©servations' }}</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Features Section -->
<section class="py-5 bg-light">
  <div class="container">
    <div class="text-center mb-5">
      <h2 class="section-title fw-bold">
        {{ 'Why Choose Nkolo Pass?' if current_language=='en' else 'Pourquoi Choisir Nkolo Pass?' }}
      </h2>
      <p class="text-muted">
        {{ 'Experience the future of bus travel in Cameroon' if current_language=='en' else 'D√©couvrez l\'avenir du voyage en bus au Cameroun' }}
      </p>
    </div>
    
    <div class="row g-4">
      <div class="col-md-4">
        <div class="text-center">
          <div class="feature-icon">
            <i class="fas fa-mobile-alt"></i>
          </div>
          <h5 class="fw-bold mb-3">{{ 'Mobile Money Payment' if current_language=='en' else 'Paiement Mobile Money' }}</h5>
          <p class="text-muted">
            {{ 'Pay securely with MTN Mobile Money, Orange Money, or any mobile wallet. No cash needed!' if current_language=='en' else 'Payez en toute s√©curit√© avec MTN Mobile Money, Orange Money ou tout portefeuille mobile. Pas besoin d\'esp√®ces!' }}
          </p>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="text-center">
          <div class="feature-icon">
            <i class="fas fa-ticket-alt"></i>
          </div>
          <h5 class="fw-bold mb-3">{{ 'Instant E-Tickets' if current_language=='en' else 'E-Billets Instantan√©s' }}</h5>
          <p class="text-muted">
            {{ 'Get your boarding pass immediately via email and SMS. No more waiting in queues!' if current_language=='en' else 'Recevez votre carte d\'embarquement imm√©diatement par email et SMS. Plus d\'attente dans les files!' }}
          </p>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="text-center">
          <div class="feature-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h5 class="fw-bold mb-3">{{ 'Trusted Operators' if current_language=='en' else 'Agences de Confiance' }}</h5>
          <p class="text-muted">
            {{ 'All our partner operators are verified and licensed. Travel with confidence and safety.' if current_language=='en' else 'Tous nos partenaires sont v√©rifi√©s et agr√©√©s. Voyagez en toute confiance et s√©curit√©.' }}
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Popular Routes Section -->
<section class="py-5">
  <div class="container">
    <div class="text-center mb-5">
      <h2 class="section-title fw-bold">
        {{ 'Popular Routes' if current_language=='en' else 'Trajets Populaires' }}
      </h2>
      <p class="text-muted">
        {{ 'Discover the most traveled routes across Cameroon' if current_language=='en' else 'D√©couvrez les trajets les plus fr√©quent√©s √† travers le Cameroun' }}
      </p>
    </div>
    
    <div class="row" id="popularTrips">
      <!-- Popular trips will be loaded here by JavaScript -->
    </div>
  </div>
</section>

<section class="py-5 bg-light">
  <div class="container">
    <!-- Ticket Search Section -->
    <div class="mt-5">
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
              <h5 class="card-title mb-3">
                <i class="fa-solid fa-ticket text-primary me-2"></i>
                {{ 'Find My Ticket' if current_language=='en' else 'Retrouver Mon Billet' }}
              </h5>
              <p class="text-muted small mb-3">
                {{ 'Enter your phone number or email to retrieve your tickets' if current_language=='en' else 'Entrez votre num√©ro de t√©l√©phone ou email pour retrouver vos billets' }}
              </p>
              
              <form id="ticketSearchForm">
                <div class="mb-3">
                  <label class="form-label">{{ 'Phone Number or Email' if current_language=='en' else 'Num√©ro de T√©l√©phone ou Email' }}</label>
                  <input type="text" class="form-control" id="searchInput" 
                         placeholder="{{ '6XXXXXXXX or email@example.com' if current_language=='en' else '6XXXXXXXX ou email@exemple.com' }}" 
                         required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  <i class="fa-solid fa-search me-2"></i>
                  {{ 'Search Tickets' if current_language=='en' else 'Rechercher Billets' }}
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-lg-6">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
              <h5 class="card-title mb-3">
                <i class="fa-solid fa-cog text-success me-2"></i>
                {{ 'Manage Booking' if current_language=='en' else 'G√©rer R√©servation' }}
              </h5>
              <p class="text-muted small mb-3">
                {{ 'Change seats or modify your trip with booking reference' if current_language=='en' else 'Changer de places ou modifier votre voyage avec la r√©f√©rence de r√©servation' }}
              </p>
              
              <form id="bookingManageForm">
                <div class="mb-3">
                  <label class="form-label">{{ 'Booking Reference' if current_language=='en' else 'R√©f√©rence de R√©servation' }}</label>
                  <input type="text" class="form-control" id="bookingRef" 
                         placeholder="{{ 'NKP123456' if current_language=='en' else 'NKP123456' }}" 
                         required>
                </div>
                <div class="mb-3">
                  <label class="form-label">{{ 'Phone or Email' if current_language=='en' else 'T√©l√©phone ou Email' }}</label>
                  <input type="text" class="form-control" id="verifyInput" 
                         placeholder="{{ 'For verification' if current_language=='en' else 'Pour v√©rification' }}" 
                         required>
                </div>
                <button type="submit" class="btn btn-success w-100">
                  <i class="fa-solid fa-edit me-2"></i>
                  {{ 'Manage Booking' if current_language=='en' else 'G√©rer R√©servation' }}
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-5">
      <h5 class="mb-3 text-secondary">{{ 'Popular this week' if current_language=='en' else 'Populaires cette semaine' }}</h5>
      <div id="popularTrips" class="row g-3"></div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  const lang = "{{ current_language }}";
  const routesApi = '/api/routes';
  const routeOpsApi = '/api/route-operators';
  const upcomingApi = '/api/upcoming-trips';

  let allCities = { from: [], to: [] };

  async function loadRoutes() {
    const res = await fetch(routesApi);
    allCities = await res.json();
    updateCityDropdowns();
  }

  function updateCityDropdowns() {
    const fromSel = document.getElementById('fromCity');
    const toSel = document.getElementById('toCity');
    const selectedFrom = fromSel.value;
    const selectedTo = toSel.value;
    
    // Update FROM dropdown (all cities available)
    fromSel.innerHTML = '<option value="">'+ (lang==='en'?'Select origin':'Choisir origine') +'</option>' + 
      allCities.from.map(c => `<option value="${c}" ${c === selectedFrom ? 'selected' : ''}>${c}</option>`).join('');
    
    // Update TO dropdown (exclude selected FROM city)
    const availableDestinations = allCities.to.filter(c => c !== selectedFrom);
    toSel.innerHTML = '<option value="">'+ (lang==='en'?'Select destination':'Choisir destination') +'</option>' + 
      availableDestinations.map(c => `<option value="${c}" ${c === selectedTo ? 'selected' : ''}>${c}</option>`).join('');
    
    // If selected TO city is same as FROM, clear it
    if (selectedTo === selectedFrom) {
      toSel.value = '';
    }
  }

  async function loadOperators() {
    const from = document.getElementById('fromCity').value;
    const to = document.getElementById('toCity').value;
    const opSel = document.getElementById('operatorSelect');
    if (!from || !to) { 
      opSel.innerHTML = '<option value="">'+(lang==='en'?'Select agency':'S√©lectionner l\'agence')+'</option>'; 
      return; 
    }
    const url = new URL(routeOpsApi, window.location.origin);
    url.searchParams.set('from', from); 
    url.searchParams.set('to', to);
    const res = await fetch(url);
    const ops = await res.json();
    opSel.innerHTML = '<option value="">'+(lang==='en'?'Select agency':'S√©lectionner l\'agence')+'</option>' +
      ops.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
  }

  async function loadUpcoming() {
    try {
      const res = await fetch(upcomingApi);
      const trips = await res.json();
      const list = document.getElementById('popularTrips');
      list.innerHTML = trips.map(t => `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="badge bg-light text-dark">${t.operator}</span>
                <span class="text-primary fw-bold">${t.price} XAF</span>
              </div>
              <h6 class="fw-bold mb-1">${t.route}</h6>
              <div class="text-secondary small">${t.date} ¬∑ ${t.departure_time}</div>
              <div class="text-secondary small">${t.available_seats} ${lang==='en'?'seats left':'places restantes'}</div>
            </div>
          </div>
        </div>`).join('');
    } catch (e) { /* ignore */ }
  }

  document.getElementById('fromCity').addEventListener('change', function() {
    updateCityDropdowns();
    loadOperators();
  });
  document.getElementById('toCity').addEventListener('change', loadOperators);

  document.getElementById('searchForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const from = document.getElementById('fromCity').value;
    const to = document.getElementById('toCity').value;
    const date = document.getElementById('travelDate').value;
    const operator = document.getElementById('operatorSelect').value;
    
    // Validate all required fields
    if (!from || !to || !date) {
      alert(lang === 'en' ? 'Please fill in all fields' : 'Veuillez remplir tous les champs');
      return;
    }
    
    // Prevent same origin and destination
    if (from === to) {
      alert(lang === 'en' ? 'Origin and destination cannot be the same' : 'L\'origine et la destination ne peuvent pas √™tre identiques');
      return;
    }
    
    // Require agency selection
    if (!operator) {
      alert(lang === 'en' ? 'Please select an agency' : 'Veuillez s√©lectionner une agence');
      return;
    }
    
    // Check if date is not in the past
    const selectedDate = new Date(date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
      alert(lang === 'en' ? 'Cannot search for trips in the past' : 'Impossible de rechercher des voyages dans le pass√©');
      return;
    }
    
    const qp = new URLSearchParams({ from, to, date, operator });
    window.location.href = `/${lang}/search?${qp.toString()}`;
  });

  // Ticket Search Form Handler
  document.getElementById('ticketSearchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const searchInput = document.getElementById('searchInput').value.trim();
    
    if (!searchInput) {
      alert(lang === 'en' ? 'Please enter phone number or email' : 'Veuillez entrer le num√©ro de t√©l√©phone ou l\'email');
      return;
    }
    
    // Redirect to my-bookings page with search parameter
    window.location.href = `/${lang}/my-bookings?search=${encodeURIComponent(searchInput)}`;
  });

  // Booking Management Form Handler
  document.getElementById('bookingManageForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const bookingRef = document.getElementById('bookingRef').value.trim();
    const verifyInput = document.getElementById('verifyInput').value.trim();
    
    if (!bookingRef || !verifyInput) {
      alert(lang === 'en' ? 'Please fill in all fields' : 'Veuillez remplir tous les champs');
      return;
    }
    
    // Redirect to dedicated booking management verification page
    window.location.href = `/${lang}/manage-booking?ref=${encodeURIComponent(bookingRef)}&verify=${encodeURIComponent(verifyInput)}`;
  });

  // Initialize page when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    loadRoutes();
    loadUpcoming();
  });
</script>
{% endblock %}
